@using ATPL_Attendance_SW.Web.Models

@{
    var states = ViewBag.States as List<MasterStateVM>;
    var cities = ViewBag.Cities as List<MasterCityVM>;
}
<link href="~/assets/css/popup.css" rel="stylesheet" />
<style>
    :root {
        --primary: #2563eb;
        --success: #16a34a;
        --border: #e5e7eb;
        --bg-soft: #f8fafc;
        --text-dark: #1f2937;
    }

    /* ===== PAGE TITLE ===== */
    .page-title {
        font-size: 22px;
        font-weight: 700;
        padding: 10px 14px;
        background: var(--bg-soft);
        border-left: 5px solid var(--primary);
        border-radius: 6px;
        color: var(--text-dark);
    }

    /* ===== SECTION TITLES ===== */
    .section-title {
        font-size: 17px;
        font-weight: 700;
        padding: 8px 12px;
        border-radius: 6px;
        background: #eef2ff;
        color: #1e3a8a;
    }

        .section-title.success {
            background: #ecfdf5;
            color: #065f46;
        }

    /* ===== TABLE STYLING ===== */
    .table {
        background: #fff;
        border: 1px solid var(--border);
    }

        .table thead th {
            background: var(--bg-soft);
            font-weight: 700;
            font-size: 14px;
            border-bottom: 2px solid var(--border);
            color: var(--text-dark);
        }

        .table td,
        .table th {
            vertical-align: middle;
            padding: 8px 10px;
        }

        .table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .table tbody tr:hover {
            background: #eef2ff;
        }

    /* ===== BUTTONS ===== */
    .btn {
        font-weight: 600;
    }

    .btn-primary {
        background: var(--primary);
        border-color: var(--primary);
    }

    .btn-success {
        background: var(--success);
        border-color: var(--success);
    }

    /* ===== MODALS ===== */
    .modal-header {
        background: var(--bg-soft);
        border-bottom: 1px solid var(--border);
    }

    .modal-title {
        font-weight: 700;
        color: var(--text-dark);
    }

    .modal-footer {
        background: #f9fafb;
        border-top: 1px solid var(--border);
    }

    .grid-scroll {
        max-height: 350px;
        overflow-y: auto;
    }

</style>

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between mb-3">
    <h2 class="page-title">State & City Master</h2>
</div>

<div class="row">

    <!-- ================= STATE LIST ================= -->
    <div class="col-md-6">
        <div class="d-flex justify-content-between mb-2">
            <h4 class="section-title">State List</h4>
            <button class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#stateModal"
                    onclick="clearState()">
                + Add State
            </button>
        </div>


        <div class="row mb-2">
            <div class="col-md-6">
                <select id="pageSize" class="form-select" style="width:120px">
                    <option value="5">Top 5</option>
                    <option value="10" selected>Top 10</option>
                    <option value="25">Top 25</option>
                    <option value="100">Top 100</option>
                </select>
            </div>

            <div class="col-md-6 text-end">
                <input type="text"
                       id="searchBox"
                       class="form-control"
                       placeholder="Search State..."
                       style="width:250px; display:inline-block;">
            </div>
        </div>

        <div class="table-responsive grid-scroll">
            <table class="table table-hover" id="deptTable">
                <thead class="table-light">
                    <tr>
                        <th>SNo</th>
                        <th>State</th>
                        <th width="150">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < states.Count; i++)
                    {
                        <tr>
                            <td>@(i + 1)</td>
                            <td>@states[i].State</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-state"
                                        data-id="@states[i].Id"
                                        data-state="@states[i].State">
                                    Edit
                                </button>

                                <form asp-action="DeleteState"
                                      method="post"
                                      style="display:inline"
                                      onsubmit="return confirm('Delete this State?');">
                                    <input type="hidden" name="id" value="@states[i].Id" />
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end mt-2">
            <ul class="pagination" id="pagination"></ul>
        </div>
    </div>
    <!-- ================= CITY LIST ================= -->
    <div class="col-md-6">
        <div class="d-flex justify-content-between mb-2">
            <h4 class="section-title success">City List</h4>
            <button class="btn btn-success"
                    data-bs-toggle="modal"
                    data-bs-target="#cityModal"
                    onclick="clearCity()">
                + Add City
            </button>
        </div>

        <div class="row mb-2">
            <div class="col-md-6">
                <select id="cityPageSize" class="form-select" style="width:120px">
                    <option value="5">Top 5</option>
                    <option value="10" selected>Top 10</option>
                    <option value="25">Top 25</option>
                    <option value="100">Top 100</option>
                </select>
            </div>

            <div class="col-md-6 text-end">
                <input type="text"
                       id="citySearchBox"
                       class="form-control"
                       placeholder="Search city..."
                       style="width:250px; display:inline-block;">

            </div>
        </div>

        <div class="table-responsive grid-scroll">
            <table class="table table-hover" id="cityTable">
                <thead class="table-light">
                    <tr>
                        <th>SNo</th>
                        <th>State</th>
                        <th>City</th>
                        <th width="120">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < cities.Count; i++)
                    {
                        var currentCity = cities[i];
                        var cityId = currentCity.Id;
                        var stateId = currentCity.StateId;

                        <tr>
                            <td>@(i + 1)</td>
                            <td>@states.First(x => x.Id == stateId).State</td>
                            <td>@currentCity.City</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-city"
                                        data-id="@cities[i].Id"
                                        data-city="@cities[i].City"
                                        data-stateid="@cities[i].StateId">
                                    Edit
                                </button>


                                <form asp-action="DeleteCity"
                                      method="post"
                                      style="display:inline"
                                      onsubmit="return confirm('Delete this City?');">
                                    <input type="hidden" name="id" value="@cityId" />
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-end mt-2">
            <ul class="pagination" id="cityPagination"></ul>
        </div>
    </div>
</div>


<!-- ================= STATE MODAL ================= -->
<div class="modal fade" id="stateModal">
    <div class="modal-dialog modal-dialog-centered" style="max-width:450px">
        <div class="modal-content">
            <form asp-action="SaveState" method="post">
                <input type="hidden" name="Id" id="StateId" />

                <div class="modal-header">
                    <h5 class="modal-title">State</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <label>State Name</label>
                    <input class="form-control text-uppercase"
                           id="StateName"
                           name="State"
                           required />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="stateSaveBtn">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= CITY MODAL ================= -->
<div class="modal fade" id="cityModal">
    <div class="modal-dialog modal-dialog-centered" style="max-width:500px">
        <div class="modal-content">
            <form asp-action="SaveCity" method="post">
                <input type="hidden" name="Id" id="CityId" />

                <div class="modal-header">
                    <h5 class="modal-title">City</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <label>Select State</label>
                    <select class="form-select mb-2" name="StateId" id="CityState" required>
                        <option value="">-- Select State --</option>
                        @foreach (var s in states)
                        {
                            <option value="@s.Id">@s.State</option>
                        }
                    </select>

                    <label>City Name</label>
                    <input class="form-control text-uppercase"
                           id="CityName"
                           name="City"
                           required />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-success" id="citySaveBtn">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= CENTER POPUP ================= -->
 @if (TempData["Msg"] != null)
{
	var type = TempData["Type"] ?? "success"; // success / error
											  	<div class="popup-overlay @type" id="centerPopup">
											  		<div class="popup-box">
											  			<div class="popup-icon @type">
											  				@(type == "success" ? "✓" : "✕")
											  			</div>

				<h4>@(type == "success" ? "Success" : "Failed")</h4>
				<p>@TempData["Msg"]</p>
			</div>
		</div>
}


<script src="~/assets/js/global.js"></script>
<script>

          const popup = document.getElementById("centerPopup");
    if (popup) {
        setTimeout(() => {
            popup.style.opacity = "0";
            setTimeout(() => popup.remove(), 300);
        }, 1500);
    }
    document.addEventListener("DOMContentLoaded", function () {

        const stateModal = new bootstrap.Modal(document.getElementById('stateModal'));
        const cityModal  = new bootstrap.Modal(document.getElementById('cityModal'));

        /* ================= STATE EDIT ================= */
        document.querySelectorAll(".edit-state").forEach(btn => {
            btn.addEventListener("click", function () {

                document.getElementById("StateId").value   = this.dataset.id;
                document.getElementById("StateName").value = this.dataset.state;

                document.getElementById("stateSaveBtn").innerText = "Update";
                stateModal.show();
            });
        });

        /* ================= CITY EDIT ================= */
        document.querySelectorAll(".edit-city").forEach(btn => {
            btn.addEventListener("click", function () {

                document.getElementById("CityId").value    = this.dataset.id;
                document.getElementById("CityName").value  = this.dataset.city;
                document.getElementById("CityState").value = this.dataset.stateid;

                document.getElementById("citySaveBtn").innerText = "Update";
                cityModal.show();
            });
        });

    });


    /* ================= CLEAR FORMS ================= */
    function clearState() {
        document.getElementById("StateId").value = "";
        document.getElementById("StateName").value = "";
        document.getElementById("stateSaveBtn").innerText = "Save";
    }

    function clearCity() {
        document.getElementById("CityId").value = "";
        document.getElementById("CityName").value = "";
        document.getElementById("CityState").value = "";
        document.getElementById("citySaveBtn").innerText = "Save";
    }
</script>


