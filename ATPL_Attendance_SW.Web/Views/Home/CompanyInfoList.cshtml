@model List<CompanyVM>

@{
	ViewData["Title"] = "Master Company";
}

<head>
	<link href="~/assets/css/popup.css" rel="stylesheet" />
</head>
<style>

	:root {
		--brand: orangered; /* template blue (soft) */
		--brand-dark: #1e3a8a;
		--border: #e5e7eb;
		--bg-soft: #f9fafb;
		--bg-section: #ffffff;
		--bg-header: #f1f5f9;
		--text-dark: #1f2937;
		--text-muted: #6b7280;
	}

	/* ===== MODAL BODY ===== */
	.modal-body {
		max-height: 70vh;
		overflow-y: auto;
		background: #f8fafc;
	}

	/* ===== FORM SECTION ===== */
	.form-section {
		background: var(--bg-section);
		border: 1px solid var(--border);
		border-radius: 8px;
		padding: 14px;
		margin-bottom: 14px;
	}

		/* ===== SECTION HEADING ===== */
		.form-section h6 {
			font-size: 13px;
			font-weight: 700;
			color: var(--brand-dark);
			margin-bottom: 12px;
			padding: 7px 10px;
			background: var(--bg-header);
			border-left: 4px solid var(--brand);
			border-radius: 6px;
		}

	/* ===== LABELS ===== */
	label {
		font-size: 12.5px;
		font-weight: 600;
		color: var(--text-muted);
		margin-bottom: 3px;
	}

	/* ===== INPUTS ===== */
	.form-control,
	.form-select {
		height: 34px;
		font-size: 13.5px;
		border-radius: 6px;
		border: 1px solid var(--border);
		background: #ffffff;
		color: var(--text-dark);
	}

	textarea.form-control {
		height: auto;
	}

	/* ===== FOCUS ===== */
	.form-control:focus,
	.form-select:focus {
		border-color: var(--brand);
		box-shadow: 0 0 0 2px rgba(59,130,246,.15);
	}

	/* ===== COLUMN DIVIDER (SUBTLE) ===== */
	.form-section .row > div {
		position: relative;
		padding-left: 10px;
		padding-right: 10px;
	}

		.form-section .row > div:not(:last-child)::after {
			content: "";
			position: absolute;
			top: 10px;
			bottom: 10px;
			right: 0;
			width: 1px;
			background: #f1f5f9;
		}

	/* ===== TABLE ===== */
	.table thead th {
		background: var(--bg-header);
		font-size: 13px;
		font-weight: 700;
		color: var(--text-dark);
		border-bottom: 1px solid var(--border);
	}

	.table tbody tr:hover {
		background: #f8fafc;
	}

	/* ===== MODAL HEADER / FOOTER ===== */
	.modal-header {
		background: var(--bg-header);
		border-bottom: 1px solid var(--border);
	}

	.modal-title {
		font-weight: 700;
		color: var(--text-dark);
	}

	.modal-footer {
		background: var(--bg-soft);
		border-top: 1px solid var(--border);
		padding: 14px 20px;
	}

	/* ===== SAVE BUTTON ===== */
	.btn-action {
		min-width: 160px;
		height: 42px;
		border-radius: 8px;
		font-size: 14.5px;
		font-weight: 700;
	}

	.btn-save {
		background: linear-gradient(135deg, orangered);
		color: #ffffff;
		border: none;
	}

		.btn-save:hover {
			background: linear-gradient(135deg, #2563eb, #1e40af);
			color: #ffffff;
		}

	label.required::after {
		content: " *";
		color: red;
	}

	.required:after {
		content: " *";
		color: red;
	}

	.form-section {
		margin-bottom: 1.5rem;
		padding: 1rem;
		border: 1px solid #dee2e6;
		border-radius: 0.25rem;
	}

		.form-section h6 {
			margin-bottom: 1rem;
			color: #495057;
			font-weight: 600;
			border-bottom: 2px solid #007bff;
			padding-bottom: 0.5rem;
		}

	.invalid-feedback {
		display: none;
		font-size: 0.875rem;
	}

	.was-validated .form-control:invalid ~ .invalid-feedback,
	.was-validated .form-select:invalid ~ .invalid-feedback {
		display: block;
	}

	.was-validated .form-control:invalid,
	.was-validated .form-select:invalid {
		border-color: #dc3545;
	}

	.was-validated .form-control:valid,
	.was-validated .form-select:valid {
		border-color: #28a745;
	}

	small.text-muted {
		font-size: 0.8rem;
		display: block;
		margin-top: 0.25rem;
	}

</style>


<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center page-header mb-3">
	<h5>Master Company</h5>
</div>

<!-- ================= TABLE ================= -->
<div class="card">
	<div class="card-body table-responsive">
		<table class="table table-hover">
			<thead>
				<tr>
					<th>Code</th>
					<th>Company</th>
					<th>City</th>
					<th>Contact</th>
					<th>GSTIN</th>
					<th width="120">Action</th>

				</tr>
			</thead>
			<tbody>
				@foreach (var c in Model)
				{
					<tr>
						<td>@c.CCode</td>
						<td>@c.CompanyName</td>
						<td>@c.City</td>
						<td>@c.ContactNo</td>
						<td>@c.GSTIN</td>
						<td>
							<button class="btn btn-sm btn-warning edit-btn"
									data-ccode="@c.CCode">
								Edit
							</button>
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>
</div>

<!-- ================= MODAL ================= -->
<div class="modal fade" id="companyModal">
	<div class="modal-dialog modal-xl modal-dialog-centered">
		<div class="modal-content">

			<form asp-action="SaveCompany" method="post" id="companyForm">

				<div class="modal-header">
					<h5 class="modal-title">Company Details</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>

				<div class="modal-body">
					<input type="hidden" id="Id" name="Id" />

					<!-- ===== Company Details ===== -->
					<div class="form-section">
						<h6>Company Details</h6>

						<div class="row">
							<div class="col-md-2 mb-2">
								<label class="required">Company Code</label>
								<input class="form-control"
									   id="CCode"
									   name="CCode"
									   required
									   maxlength="10"
									   @* pattern="[A-Za-z0-9]+" *@
									   title="Only alphanumeric characters allowed" />
								<div class="invalid-feedback">Company Code is required (max 10 characters, alphanumeric only)</div>
							</div>

							<div class="col-md-8 mb-2">
								<label class="required">Company Name</label>
								<input class="form-control"
									   id="CompanyName"
									   name="CompanyName"
									   required
									   maxlength="200"
									   minlength="3" />
								<div class="invalid-feedback">Company Name is required (3-200 characters)</div>
							</div>

							<div class="col-md-2 mb-2">
								<label class="required">Abbreviation</label>
								<input class="form-control"
									   id="Abbr"
									   name="Abbr"
									   required
									   maxlength="10"
									   minlength="2" />
								<div class="invalid-feedback">Abbreviation is required (2-10 characters)</div>
							</div>

							<div class="col-md-3 mb-2">
								<label>GSTIN</label>
								<input class="form-control"
									   id="GSTIN"
									   name="GSTIN"
									   maxlength="15"
									   @* pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}" *@
									   title="Enter valid GSTIN (15 characters)" />
								<div class="invalid-feedback">Enter valid GSTIN format (e.g., 22AAAAA0000A1Z5)</div>
							</div>

							<div class="col-md-3 mb-2">
								<label>UAN No.</label>
								<input class="form-control"
									   id="UANNo"
									   name="UANNo"
									   maxlength="12"
									   pattern="[0-9]{12}"
									   title="UAN should be 12 digits" />
								<div class="invalid-feedback">UAN should be 12 digits</div>
							</div>

							<div class="col-md-3 mb-2">
								<label>PAN No.</label>
								<input class="form-control"
									   id="PANNo"
									   name="PANNo"
									   maxlength="10"
									   @* pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" *@
									   style="text-transform: uppercase;"
									   title="Enter valid PAN (e.g., ABCDE1234F)" />
								<div class="invalid-feedback">Enter valid PAN format (e.g., ABCDE1234F)</div>
							</div>

							<div class="col-md-3 mb-2">
								<label>License No.</label>
								<input class="form-control"
									   id="LicenseNo"
									   name="LicenseNo"
									   maxlength="50" />
								<div class="invalid-feedback">License No. max 50 characters</div>
							</div>

						</div>
					</div>

					<!-- ===== Address Details ===== -->
					<div class="form-section">
						<h6>Contact Details</h6>

						<div class="row">
							<div class="col-md-3 mb-2">
								<label>Country</label>
								<select id="Country"
										name="Country"
										class="form-select"
										onchange="loadStates(this.value)">
									<option value="">Select Country</option>
									<option value="India">India</option>
									<option value="America">America</option>
									<option value="UK">UK</option>
								</select>
							</div>

							<div class="col-md-3 mb-2">
								<label>State</label>
								<select class="form-select"
										name="StateId"
										id="StateId"
										onchange="loadCities(this.value)">
									<option value="">-- Select State --</option>
									@foreach (var d in (List<SelectListItem>)ViewBag.StateList)
									{
										<option value="@d.Value">@d.Text</option>
									}
								</select>
							</div>

							<div class="col-md-3 mb-2">
								<label>City</label>
								<select class="form-select" name="CityId" id="CityId">
									<option value="">-- Select City --</option>
								</select>
							</div>

							<div class="col-md-3 mb-2">
								<label>Pincode</label>
								<input class="form-control"
									   id="Pincode"
									   name="Pincode"
									   maxlength="6"
									   pattern="[0-9]{6}"
									   title="Enter 6 digit pincode" />
								<div class="invalid-feedback">Enter valid 6 digit pincode</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6 mb-2">
								<label>Address 1</label>
								<textarea type="text"
										  class="form-control"
										  id="Address"
										  name="Address"
										  rows="2"
										  maxlength="250"></textarea>
								<small class="text-muted">Max 250 characters</small>
							</div>

							<div class="col-md-6 mb-2">
								<label>Address 2</label>
								<textarea type="text"
										  class="form-control"
										  id="Address2"
										  name="Address2"
										  rows="2"
										  maxlength="250"></textarea>
								<small class="text-muted">Max 250 characters</small>
							</div>

							<div class="col-md-3 mb-2">
								<label>Telephone</label>
								<input class="form-control"
									   id="Telepohne"
									   name="Telepohne"
									   maxlength="15"
									   @* pattern="[0-9\-\+\(\)\s]+" *@
									   title="Enter valid telephone number" />
								<div class="invalid-feedback">Enter valid telephone number</div>
							</div>

							<div class="col-md-3 mb-2">
								<label class="required">Contact No</label>
								<input class="form-control"
									   id="ContactNo"
									   name="ContactNo"
									   required
									   maxlength="10"
									   pattern="[0-9]{10}"
									   title="Enter 10 digit mobile number" />
								<div class="invalid-feedback">Enter valid 10 digit mobile number</div>
							</div>

							<div class="col-md-3 mb-2">
								<label>Email</label>
								<input class="form-control"
									   id="Email"
									   name="Email"
									   type="email"
									   maxlength="100"
									   title="Enter valid email address" />
								<div class="invalid-feedback">Enter valid email address</div>
							</div>

							<div class="col-md-3 mb-2">
								<label>Website</label>
								<input class="form-control"
									   id="Website"
									   name="Website"
									   type="url"
									   maxlength="100"
									   @* pattern="https?://.+" *@
									   title="Enter valid website URL (e.g., https://example.com)" />
								<div class="invalid-feedback">Enter valid website URL</div>
							</div>

						</div>
					</div>

					<!-- ===== Bank Details ===== -->
					<div class="form-section">
						<h6>Bank Details</h6>

						<div class="row">
							<div class="col-md-4 mb-2">
								<label>Bank Name</label>
								<input class="form-control"
									   id="BankName"
									   name="BankName"
									   maxlength="100" />
								<div class="invalid-feedback">Bank Name max 100 characters</div>
							</div>

							<div class="col-md-4 mb-2">
								<label>Account No</label>
								<input class="form-control"
									   id="AccountNo"
									   name="AccountNo"
									   maxlength="20"
									   pattern="[0-9]+"
									   title="Enter valid account number (digits only)" />
								<div class="invalid-feedback">Enter valid account number (max 20 digits)</div>
							</div>

							<div class="col-md-4 mb-2">
								<label>IFSC Code</label>
								<input class="form-control"
									   id="IFSCCode"
									   name="IFSCCode"
									   maxlength="11"
									   @* pattern="[A-Z]{4}0[A-Z0-9]{6}" *@
									   style="text-transform: uppercase;"
									   title="Enter valid IFSC Code (e.g., SBIN0001234)" />
								<div class="invalid-feedback">Enter valid IFSC Code (11 characters, e.g., SBIN0001234)</div>
							</div>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="submit"
							class="btn btn-action btn-save">
						Save
					</button>
				</div>

			</form>
		</div>
	</div>
</div>

@if (TempData["Msg"] != null)
{
	var type = TempData["Type"] ?? "success"; // success / error
											  <div class="popup-overlay @type" id="centerPopup">
											  	<div class="popup-box">
											  		<div class="popup-icon @type">
											  			@(type == "success" ? "✓" : "✕")
											  		</div>

			<h4>@(type == "success" ? "Success" : "Failed")</h4>
			<p>@TempData["Msg"]</p>
		</div>
	</div>
}



@section Scripts {
	<partial name="_ValidationScriptsPartial" />
}

	<script>

				  const popup = document.getElementById("centerPopup");
	if (popup) {
		setTimeout(() => {
			popup.style.opacity = "0";
			setTimeout(() => popup.remove(), 300);
		}, 1500);
	}

	// ===== CLEAR FORM =====
	function clearForm() {

		document.querySelectorAll('#companyModal input, #companyModal textarea')
			.forEach(x => x.value = '');

		document.getElementById("StateId").value = "";
		document.getElementById("CityId").innerHTML = '<option value="">-- Select City --</option>';

		//CompanyName.readOnly = true;
		Id.value = 0;
		setButtonMode(false);
	}

	// ===== LOAD COMPANY =====

		function loadCompanyByCode(ccode) {

		fetch('/Home/GetCompanyByCode?ccode=' + encodeURIComponent(ccode))
			.then(r => r.json())
			.then(d => {

				if (!d) return;

				Id.value = d.id;
				CCode.value = d.ccode;
				CompanyName.value = d.companyName;
				Abbr.value = d.abbr;

				Country.value = d.country;
				Address.value = d.address;
				Address2.value = d.address2;
				Pincode.value = d.pincode;

				Telepohne.value = d.telepohne;   // ✅ FIXED
				ContactNo.value = d.contactNo;
				Email.value = d.email;
				GSTIN.value = d.gstin;
				Website.value = d.website;

				BankName.value = d.bankName;
				AccountNo.value = d.accountNo;
				IFSCCode.value = d.ifscCode;
				LicenseNo.value = d.licenseNo;
				UANNo.value = d.uanNo;
				PANNo.value = d.panNo;

				// IMPORTANT
				loadStates(d.stateId, d.cityId);

				setButtonMode(true);
			});
	}




	// ===== LOAD STATES =====
		function loadStates(selectedStateId, selectedCityId) {

		const stateDDL = document.getElementById("StateId");
		const cityDDL = document.getElementById("CityId");

		stateDDL.innerHTML = '<option value="">-- Select State --</option>';
		cityDDL.innerHTML = '<option value="">-- Select City --</option>';

		fetch('/Home/LoadStates')
			.then(r => r.json())
			.then(data => {

				data.forEach(x => {
					stateDDL.innerHTML +=
						`<option value="${x.value}">${x.text}</option>`;
				});

				if (selectedStateId) {
					stateDDL.value = selectedStateId;

					// ✅ WAIT then load cities
					setTimeout(() => {
						loadCities(selectedStateId, selectedCityId);
					}, 200);
				}
			});
	}


	// ===== LOAD CITIES =====
	 function loadCities(stateId, selectedCityId) {

		const cityDDL = document.getElementById("CityId");
		cityDDL.innerHTML = '<option value="">-- Select City --</option>';

		if (!stateId) return;

		fetch('/Home/LoadCities?stateId=' + stateId)
			.then(r => r.json())
			.then(data => {

				data.forEach(x => {
					cityDDL.innerHTML +=
						`<option value="${x.value}">${x.text}</option>`;
				});

				if (selectedCityId) {
					cityDDL.value = selectedCityId;
				}
			});
	}


	// ===== BUTTON MODE =====
	function setButtonMode(isEdit) {
		document.querySelector('.btn-save').innerText =
			isEdit ? 'Update' : 'Save';
	}

</script>

<script>
	document.querySelectorAll('.edit-btn').forEach(btn => {
		btn.addEventListener('click', function () {
			const ccode = this.getAttribute('data-ccode');

			new bootstrap.Modal(document.getElementById('companyModal')).show();
			loadCompanyByCode(ccode);
		});
	});
</script>
<script>
	// Bootstrap form validation
	(function () {
		'use strict'

		// Fetch the form
		var form = document.getElementById('companyForm')

		// Add submit event listener
		form.addEventListener('submit', function (event) {
			if (!form.checkValidity()) {
				event.preventDefault()
				event.stopPropagation()
			}

			form.classList.add('was-validated')
		}, false)

		// Auto-uppercase for PAN and IFSC
		document.getElementById('PANNo').addEventListener('input', function(e) {
			this.value = this.value.toUpperCase();
		});

		document.getElementById('IFSCCode').addEventListener('input', function(e) {
			this.value = this.value.toUpperCase();
		});

		// Restrict Contact No to numbers only
		document.getElementById('ContactNo').addEventListener('input', function(e) {
			this.value = this.value.replace(/[^0-9]/g, '');
		});

		// Restrict Pincode to numbers only
		document.getElementById('Pincode').addEventListener('input', function(e) {
			this.value = this.value.replace(/[^0-9]/g, '');
		});

		// Restrict UAN to numbers only
		document.getElementById('UANNo').addEventListener('input', function(e) {
			this.value = this.value.replace(/[^0-9]/g, '');
		});

		// Restrict Account No to numbers only
		document.getElementById('AccountNo').addEventListener('input', function(e) {
			this.value = this.value.replace(/[^0-9]/g, '');
		});
	})()
</script>